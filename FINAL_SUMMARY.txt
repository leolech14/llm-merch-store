================================================================================
COMPLETE API SPRAWL ANALYSIS - LLMMERCH.SPACE
================================================================================

PROJECT: /Users/lech/PROJECTS_all/PROJECT_merch/llm-merch-store/app/api
ANALYSIS DATE: 2025-10-30
SCOPE: All 15 API routes across app/api/**/route.ts

================================================================================
KEY METRICS
================================================================================

Total API Routes: 15 (across 11 files)
Actively Used: 8 APIs
Unused/Legacy: 9 APIs  
Duplicate Logic: 3 major patterns + multiple helper duplications
File Duplication: ensureDataDir() repeated 6 times
File I/O Duplication: Read/Write patterns repeated 4-5 times

Estimated Code Reduction: 40-50% through consolidation
Security Issues: 4 (no rate limiting, hardcoded config, no input validation, missing auth)

================================================================================
DUPLICATE ENDPOINTS (PRIORITY FIX)
================================================================================

1. VISITOR TRACKING DUPLICATION
   - /api/visitors (simple counter) vs /api/telemetry (event system)
   - Impact: DELETE /api/visitors, use telemetry with eventType='visitor'
   - Frontend calls: app/page.tsx:449 (1 location)

2. STATS/METRICS DUPLICATION  
   - /api/stats (reads telemetry.json, legacy) vs /api/metrics (reads event-store, modern)
   - Both return: totalVisitors, totalPageViews, totalSales, etc.
   - Impact: DEPRECATE /api/stats, migrate to /api/metrics
   - Frontend calls: page.tsx:450, admin/page.tsx:55 (2 locations)

3. OFFERS/TRANSACTIONS CONFLICT
   - /api/offers/* (standalone system) vs /api/transactions (event-store based)
   - Impact: DELETE /api/offers (unused anyway)
   - Frontend calls: NONE (unused)

================================================================================
UNUSED ENDPOINTS (CAN DELETE)
================================================================================

1. /api/offers (GET, POST, PUT)           - LEGACY offer system, never called
2. /api/events (POST)                     - Manual event recording, never called  
3. /api/transactions (GET, POST)          - Prepared but unused from frontend
4. /api/collectors (GET)                  - Prepared but unused from frontend
5. /api/system-config (GET)               - Only POST is used
6. /api/ask (GET)                         - Health check, unnecessary

Consolidation Opportunity: Remove 6 unused endpoints without breaking anything

================================================================================
FILE I/O DUPLICATION
================================================================================

ensureDataDir() - REPEATED 6 TIMES
  Files: visitors, offers, inventory, telemetry, admin/system-config, admin/hero-config
  Solution: Create lib/data-access.ts, export ensureDataDir()

readFileSync Pattern - REPEATED 5 TIMES  
  Files: stats, metrics, market-prices (2x), hero-config
  Solution: Create async readJsonFile<T>() utility

writeFileSync Pattern - REPEATED 4 TIMES
  Files: visitors, offers, inventory, telemetry
  Solution: Create async writeJsonFile<T>() utility

Impact: Move 30+ lines of duplicated code to single utility module

================================================================================
HARDCODED VALUES
================================================================================

1. BASE PRICE (R$149)
   Files: inventory/route.ts:39, market-prices/route.ts:24
   Solution: Move to env var or system-config API

2. SALE DATES (57 hours 25 minutes from now)
   File: sale-status/route.ts:17-18
   Solution: Move to /api/admin/system-config with saleStartTime/saleEndTime

3. ADMIN EMAILS
   File: auth/[...nextauth]/route.ts:12-15
   Solution: Move to ADMIN_EMAILS env var

4. EVENT TYPE VALIDATION
   Files: telemetry/route.ts, transactions/route.ts
   Solution: Create shared EventType validation

================================================================================
MISSING ERROR HANDLING
================================================================================

1. NO INPUT VALIDATION
   - /api/telemetry POST: accepts any eventType string (should validate enum)
   - /api/ask POST: no sanitization
   - /api/events GET: no limit enforcement (could request 1M events)
   - /api/transactions POST: doesn't validate if product exists

2. INCONSISTENT ERROR RESPONSES
   Pattern A: { error: '...' }
   Pattern B: { success: false, error: '...' }
   Pattern C: Both (different endpoints)
   Solution: Standardize to { success: boolean, data?, error?, errors? }

3. NO INPUT SANITIZATION
   - XSS risk in /api/ask (question not sanitized)
   - /api/telemetry accepts arbitrary eventData

================================================================================
SECURITY ISSUES
================================================================================

1. NO RATE LIMITING
   - /api/telemetry POST can be spammed: for i in {1..10000}; do curl /api/telemetry -X POST; done
   - Leads to: event store file bloat, metrics corruption

2. HARDCODED ADMIN EMAILS
   - In code instead of env var
   - Makes it hard to update without redeploy

3. NO CSRF PROTECTION
   - Admin endpoints POST don't validate CSRF tokens
   - NextAuth provides csrfToken but not used

4. MISSING FILE LOCKING
   - fs.writeFileSync has race conditions in concurrent writes
   - Example: 2 requests read same file, both write back = data loss

5. NO QUERY VALIDATION
   - /api/events?limit=1000000 would load entire event store

================================================================================
USAGE ANALYSIS
================================================================================

ACTUALLY CALLED FROM FRONTEND:
1. app/page.tsx
   - POST /api/telemetry (3x: page_view, product_click, product_like)
   - POST /api/visitors (1x)
   - GET /api/stats (1x)
   - GET /api/sale-status (2x)
   - GET /api/inventory (1x)
   - GET /api/market-prices (1x)

2. components/product-detail-modal.tsx
   - POST /api/telemetry (2x)

3. app/admin/page.tsx
   - GET /api/metrics (1x)
   - GET /api/admin/hero-config (1x)
   - POST /api/admin/system-config (1x)

4. components/progressive-hero-messages.ts
   - GET /api/admin/hero-config (1x)

5. components/hero-wtf-dynamic.tsx
   - POST /api/ask (1x)

TOTAL ACTUAL CALLS: ~15 API calls from frontend

================================================================================
MISSING TYPES
================================================================================

Implicit Any in 6+ locations:
- stats/route.ts:22 - sort callback  
- stats/route.ts:27 - reduce callback
- metrics/route.ts:28 - filter callback (any)
- market-prices/route.ts:40 - product: any
- market-prices/route.ts:42 - offer: any
- hero-config/route.ts - type assertions

Type Inconsistency:
- offers/route.ts defines Offer interface
- transactions/route.ts uses different structure
- No shared type definitions

Solution: Create lib/api-types.ts with shared interfaces

================================================================================
SYNC I/O IN ASYNC ROUTES
================================================================================

Problem: fs.readFileSync blocks event loop in async functions

Current (BLOCKS):
export async function GET() {
  const data = JSON.parse(fs.readFileSync(FILE, 'utf-8'));
  // Function is async but does sync blocking I/O
}

Better (NON-BLOCKING):
export async function GET() {
  const data = JSON.parse(await fs.promises.readFile(FILE, 'utf-8'));
  // Actually async
}

Impact: Improves response times under high concurrency

================================================================================
EVENT STORE FILE GROWTH
================================================================================

Current: if (store.events.length > 10000) { store.events = store.events.slice(-10000); }
Issue: Keeps 10k events Ã— 500 bytes = 5MB+ file, grows unbounded
Risk: Memory issues, slow JSON.parse() on large files

Solution: 
1. Implement rolling archives (event-store-2025-10.json, etc)
2. Consider database for long-term storage
3. Or add hard size limit (e.g., 2MB max)

================================================================================
CONSOLIDATION ROADMAP
================================================================================

PHASE 1: QUICK WINS (No breaking changes)
  1. Delete unused endpoints (1 day)
     - /api/offers/*
     - /api/events POST
     - /api/transactions GET/POST (comment out)
     - /api/collectors
     - /api/ask GET
     - /api/system-config GET
  
  2. Create lib/data-access.ts (1 day)
     - Move ensureDataDir()
     - Move readJsonFile()
     - Move writeJsonFile()
  
  3. Create lib/api-response.ts (0.5 day)
     - Standardize error/success responses
  
  4. Create lib/api-types.ts (0.5 day)
     - Shared interfaces

PHASE 2: MEDIUM IMPACT (Requires testing)
  1. Delete /api/visitors (1 day)
     - Update app/page.tsx to use /api/telemetry

  2. Deprecate /api/stats (1 day)
     - Update page.tsx:450 to use /api/metrics
     - Optionally keep /api/stats as proxy to /api/metrics for now
  
  3. Move hardcoded values (1 day)
     - BASE_PRICE to env var
     - SALE DATES to /api/admin/system-config
     - ADMIN_EMAILS to env var

PHASE 3: SECURITY HARDENING (2-3 days)
  1. Add input validation middleware
  2. Add rate limiting to /api/telemetry POST
  3. Add CSRF protection to admin endpoints
  4. Add query limits to /api/events GET
  5. Switch sync I/O to async fs.promises
  6. Add file locking or use database

PHASE 4: CODE QUALITY (Ongoing)
  1. Remove implicit any types
  2. Add JSDoc comments to utilities
  3. Add integration tests for API contracts
  4. Document API schema (OpenAPI/Swagger)

TIMELINE: 1 week to complete all phases
RISK: LOW (Phase 1 is non-breaking)

================================================================================
QUICK STATS
================================================================================

Lines of Duplicated Code: ~150 lines
Potential Code Reduction: 40-50%
APIs to Delete: 6
APIs to Consolidate: 2
Helper Functions Duplicated: 3
Files Affected: 11 route files

After Refactoring:
- 9 API endpoints (down from 15)
- 3-4 shared utility modules
- 100% type safety (no implicit any)
- Consistent error handling
- Input validation on all routes
- Rate limiting on sensitive endpoints

================================================================================
FILES TO CREATE
================================================================================

1. lib/data-access.ts
   - ensureDataDir()
   - readJsonFile<T>()
   - writeJsonFile<T>()
   - withDataDir() helper
   
2. lib/api-types.ts
   - Product interface
   - Offer interface
   - Transaction interface
   - Event types
   - SystemConfig interface
   
3. lib/api-response.ts
   - ApiResponse.success<T>()
   - ApiResponse.error()
   - ApiResponse.validation()
   
4. lib/validation.ts
   - validateEventType()
   - validateLimit()
   - validateEmail()
   - sanitizeString()

5. lib/rate-limiter.ts (optional)
   - Simple in-memory rate limiter
   - Or use middleware library

================================================================================
FILES TO DELETE
================================================================================

1. app/api/visitors/ (move to telemetry)
2. app/api/offers/ (legacy, unused)
3. app/api/events/POST (unused)
4. app/api/transactions/ (comment out, keep for future)
5. app/api/collectors/ (comment out, keep for future)
6. app/api/ask/GET (remove health check)

================================================================================
FILES TO MODIFY
================================================================================

1. app/api/stats/ - DELETE, redirect to metrics
2. app/api/telemetry/ - Add validation, use data-access layer
3. app/api/metrics/ - Use data-access layer
4. app/api/inventory/ - Use data-access layer
5. app/api/market-prices/ - Use data-access layer
6. app/api/sale-status/ - Read dates from config
7. app/api/admin/system-config/ - Add saleStartTime/saleEndTime
8. app/api/admin/hero-config/ - Use data-access layer
9. app/api/auth/ - Use env var for ADMIN_EMAILS
10. app/page.tsx - Use /api/telemetry instead of /api/visitors
11. app/page.tsx - Use /api/metrics instead of /api/stats
12. app/admin/page.tsx - Use /api/metrics instead of /api/stats

================================================================================
CRITICAL ISSUES TO FIX IMMEDIATELY
================================================================================

1. RACE CONDITION IN FILE WRITES
   Risk: HIGH - Data corruption possible
   Fix: Implement file locking or switch to database
   Timeline: 1-2 days

2. NO INPUT VALIDATION
   Risk: MEDIUM - Invalid data can corrupt metrics
   Fix: Add validation middleware
   Timeline: 1 day

3. NO RATE LIMITING ON PUBLIC ENDPOINTS
   Risk: MEDIUM - Spam attacks possible
   Fix: Add rate limiting to /api/telemetry POST
   Timeline: 0.5 days

4. HARDCODED ADMIN EMAILS
   Risk: LOW - Security through obscurity
   Fix: Move to env var
   Timeline: 0.5 days

================================================================================
RECOMMENDED READING ORDER
================================================================================

1. This summary (you are here)
2. /tmp/api_analysis.md - Detailed inventory & findings
3. /tmp/duplicate_code_examples.md - Code examples for each issue

================================================================================
